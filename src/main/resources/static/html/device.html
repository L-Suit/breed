<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>设备管理-智慧水产养殖系统</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/breed.css">
    <link rel="stylesheet" href="../css/toastr.css">
</head>
<body>
<div class="container-fluid">
    <!-- 侧边栏 -->
    <div class="panel panel-default col-sm-2">
        <ul class="nav nav-pills nav-stacked">
            <li role="presentation"><a href="/">首页</a></li>
            <li role="presentation"><a href="/pool">塘口管理</a></li>
            <li role="presentation" class="active"><a href="/device">设备管理</a></li>
            <li role="presentation"><a href="/system">系统设置</a></li>
            <li role="presentation"><a href="/logout">退出</a></li>
        </ul>
    </div>
    <!-- 主体 -->
    <div class="panel panel-default col-sm-10">
        <h3 class="custom-panel-title">设备列表</h3>
        <div class="panel-heading">
            <form class="form-inline">
                <div class="form-group">
                    <button class="btn btn-info" type="button" onclick="showDeviceModel()">添加设备</button>
                </div>
                <div class="form-group">
                    <input type="text" id="deviceIMEI" class="form-control" placeholder="请输入设备IEMI号">
                </div>
                <button type="button" class="btn btn-default" onclick="findDevice()">查找</button>
            </form>
        </div>
        <div class="panel-body">
            <!-- 设备列表 -->
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>设备名</th>
                    <th>IMEI</th>
                    <th>回传参数</th>
                    <th>状态</th>
                    <th>所属塘口</th>
                    <th>同步时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="deviceTbody"></tbody>
            </table>
            <!-- 绑定塘口模态框 -->
            <div class="modal fade" id="bindPoolModel" tabindex="-1" role="dialog" aria-labelledby="bindPoolModelLabel">
                <div class="modal-dialog" role="document" style="width:1100px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="bindPoolModelLabel">绑定塘口</h4>
                        </div>
                        <div class="modal-body" id="deviceModelBody">
                            <input type="hidden" id="userDeviceId">
                            <select id="poolSelect" class="form-control">
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" onclick="bindPool()">绑定</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 设备模态框 -->
            <div class="modal fade" id="deviceModel" tabindex="-1" role="dialog" aria-labelledby="deviceModelLabel">
                <div class="modal-dialog" role="document" style="width:1100px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="deviceModelLabel">添加设备</h4>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal" id="deviceForm">
                                <div class="form-group">
                                    <label for="inputDeviceSelect" class="col-sm-2 control-label">设备名称</label>
                                    <div class="col-sm-10">
                                        <select id="inputDeviceSelect" class="form-control" name="deviceId">
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputIMEI" class="col-sm-2 control-label">IMEI</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="inputIMEI" name="imei">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">当前状态</label>
                                    <div class="col-sm-10">
                                        <label class="radio-inline">
                                            <input type="radio" name="status" value="0"> <span style="color: red">STOP</span>
                                        </label>
                                        <label class="radio-inline">
                                            <input type="radio" name="status"  value="1" checked="checked"> <span style="color: green">START</span>
                                        </label>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" onclick="addDevice()">添加</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 设备状态模态框 -->
            <div class="modal fade" id="devStatusModel" tabindex="-1" role="dialog" aria-labelledby="devStatusModelLabel">
                <div class="modal-dialog" role="document" style="width:1100px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="devStatusModelLabel">设备状态</h4>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal">
                                <input type="hidden" id="inputDevId">
                                <div class="form-group">
                                    <label for="inputIMEI1" class="col-sm-2 control-label">IMEI</label>
                                    <div class="col-sm-10">
                                        <p id="inputIMEI1" class="form-control-static"></p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">当前状态</label>
                                    <div class="col-sm-5">
                                        <p id="devStatusDiv" class="form-control-static"></p>
                                    </div>
                                    <div class="col-sm-5">
                                        <button class="btn btn-info" onclick="updateDevStatus()" type="button">更新状态</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputStart" class="col-sm-2 control-label">定时启动（单位：秒）</label>
                                    <div class="col-sm-5">
                                        <input type="number" class="form-control" id="inputStart">
                                    </div>
                                    <div class="col-sm-5">
                                        <button class="btn btn-warning" onclick="setTimeStart()" type="button">设置</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputClose" class="col-sm-2 control-label">定时关闭（单位：秒）</label>
                                    <div class="col-sm-5">
                                        <input type="number" class="form-control" id="inputClose">
                                    </div>
                                    <div class="col-sm-5">
                                        <button class="btn btn-warning" onclick="setTimeClose()" type="button">设置</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../js/jquery-3.2.1.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/toastr.js"></script>
<script src="../js/http.js"></script>
<script src="../js/breed.js"></script>
<script>
    $(function () {
        sendJson("get", "/device/", {}, false, function (res) {
                if (res.status) {
                    var data = res.data;
                    var html = "";
                    for(var i=0; i<data.length;i++) {
                        var status = "";
                        if(data[i].status === 1) {
                            status = "<span style='color: green'>START</span>";
                        } else {
                            status = "<span style='color: red'>STOP</span>";
                        }

                        var poolName = data[i].poolName == null ? "" : data[i].poolName;
                        var poolButton="";
                        if(data[i].poolId == null) {
                            poolButton = '<button class="btn btn-primary" onclick="showBindModel(this)" style="margin-left: 10px">绑定</button>';
                        } else {
                            poolButton = '<button class="btn btn-warning" onclick="unbindPool(this)" style="margin-left: 10px">解绑</button>';
                        }

                        var tr = '<tr data-id="'+data[i].id+'" device-id="'+data[i].deviceId+'" pool-id="'+data[i].poolId+'">\n' +
                            '                        <td>'+data[i].deviceName+'</td>\n' +
                            '                        <td>'+data[i].imei+'</td>\n' +
                            '                        <td>'+data[i].params+'</td>\n' +
                            '                        <td>'+status+'</td>\n' +
                            '                        <td>'+poolName+'</td>\n' +
                            '                        <td>'+data[i].updateDate+'</td>\n' +
                            '                        <td>' + poolButton + '\n' +
                            '<button class="btn btn-info" onclick="showDevStatus(this)" style="margin-left: 10px">状态</button>\n' +
                            '<button class="btn btn-danger" onclick="deleteDevice(this)" style="margin-left: 10px">删除</button></td>\n' +
                            '                    </tr>';
                        html += tr + "\n";
                    }
                    document.getElementById('deviceTbody').innerHTML = html;
                } else {
                    toastr.info(res.info);
                }
            },
            function () {
                toastr.error("系统错误");
            });
    });

    // 显示绑定塘口模态框
    function showBindModel(obj) {
        var id = $(obj).parent().parent().attr("data-id");
        // 获取塘口列表
        sendJson("get", "/pool/", {}, false, function (res) {
                if (res.status) {
                    var data = res.data;
                    var html = "";
                    for(var i=0;i<data.length;i++){
                        html += '<option value="'+data[i].id+'">'+data[i].name+'</option>';
                    }
                    document.getElementById("poolSelect").innerHTML = html;

                    $("#userDeviceId").val(id);
                    $("#bindPoolModel").modal("show");
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }

    // 绑定塘口
    function bindPool() {
        var poolId =  $('#poolSelect option:selected').val();
        var id = $("#userDeviceId").val();
        sendJson("post", "/pool/device/", {"id": id,"poolId":poolId}, false, function (res) {
                if (!res.status) {
                    toastr.warning(res.info);
                } else {
                    toastr.success("绑定成功");
                    $("#bindPoolModel").modal("hide");
                    window.location.reload();
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }

    // 解绑塘口
    function unbindPool(obj) {
        var id = $(obj).parent().parent().attr("data-id");
        var msg = "确认要从塘口中解绑吗";
        if(confirm(msg)) {
            sendJson("delete", "/pool/device/" + id, {}, false, function (res) {
                    if (!res.status) {
                        toastr.warning(res.info);
                    } else {
                        toastr.success("解绑成功");
                        window.location.reload();
                    }
                },
                function () {
                    toastr.error("系统错误");
                });
        } else {
            return false;
        }
    }
    
    // 删除设备
    function deleteDevice(obj) {
        var id = $(obj).parent().parent().attr("data-id");
        var msg = "删除后无法恢复，确认要删除吗";
        if(confirm(msg)) {
            sendJson("delete", "/device/" + id, {}, false, function (res) {
                    if (!res.status) {
                        toastr.warning(res.info);
                    } else {
                        toastr.success("解绑成功");
                        window.location.reload();
                    }
                },
                function () {
                    toastr.error("系统错误");
                });
        } else {
            return false;
        }
    }

    // 获取指定设备状态
    function getDevStatus(id) {
        var devStatus = "<span style='color: gray'>NONE</span>";;
        sendJson("get", "/pool/device/status/" + id, {}, false, function (res) {
                if(res.status) {
                    if(res.data === 1) {
                        devStatus = "<span style='color: green'>START</span>";
                    } else if(res.data === 0) {
                        devStatus = "<span style='color: red'>STOP</span>";
                    }
                }
            },
            function () {
                toastr.error("系统错误");
            });
        return devStatus;
    }

    // 显示设备模态框
    function showDeviceModel() {
        sendJson("get", "/device/list", {}, false, function (res) {
                if (res.status) {
                    var data = res.data;
                    var html ="";
                    for(var i=0; i<data.length; i++) {
                        html += '<option value="'+data[i].id+'">'+data[i].name + ' ' + data[i].modelNum +'</option>';
                    }
                    document.getElementById("inputDeviceSelect").innerHTML = html;
                    $("#deviceModel").modal("show");
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }

    // 设备状态模态框中的更新状态方法
    function updateDevStatus() {
        var id = $("#inputDevId").val();
        var status = getDevStatus(id);
        $("#devStatusDiv").html(status);
    }

    // 显示设备状态模态框
    function showDevStatus(obj) {
        var id = $(obj).parent().parent().attr("data-id");
        $("#inputDevId").val(id);

        var imei = $(obj).parent().prev().prev().prev().prev().prev().html();
        $("#inputIMEI1").text(imei);

        var status = getDevStatus(id);
        $("#devStatusDiv").html(status);

        $("#devStatusModel").modal("show");
    }

    // 设置设备定时启动
    function setTimeStart() {
        var devId = $("#inputDevId").val();
        var second = $("#inputStart").val();
        if(second === "") {
            toastr.warning("时间不能为空");
            return false;
        }
        devTask(1,second,devId);
    }

    // 设置设备定时关闭
    function setTimeClose() {
        var second = $("#inputClose").val();
        var devId = $("#inputDevId").val();
        if(second === "") {
            toastr.warning("时间不能为空");
            return false;
        }
        devTask(0,second,devId);
    }

    /*
        设备任务
        type：类型；0：关闭；1：启动
        second：秒数
        devId：设备id
     */
    function devTask(type,second,devId) {
        sendJson("post", "/pool/device/task", {type:type, second:second,id:devId}, false, function (res) {
                if(res.status) {
                    toastr.success("设置成功");
                } else {
                    toastr.error("设置失败");
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }

    // 添加设备
    function addDevice() {
        sendJson("post", "/device/", $("#deviceForm").serialize(), false, function (res) {
                if(res.status) {
                    $('#deviceModel').modal('hide');
                    window.location.reload();
                } else {
                    toastr.info(res.info);
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }

    // 查找设备
    function findDevice() {
        var imei = $("#deviceIMEI").val();
        sendJson("get", "/device/imei/" + imei, {}, false, function (res) {
                if (res.status) {
                    var data = res.data;
                    var html = "";
                    for(var i=0; i<data.length;i++) {
                        var status = "";
                        if(data[i].status === 1) {
                            status = "<span style='color: green'>START</span>";
                        } else {
                            status = "<span style='color: red'>STOP</span>";
                        }

                        var poolName = data[i].poolName == null ? "" : data[i].poolName;
                        var poolButton="";
                        if(data[i].poolId == null) {
                            poolButton = '<button class="btn btn-primary" onclick="showBindModel(this)" style="margin-left: 10px">绑定</button>';
                        } else {
                            poolButton = '<button class="btn btn-warning" onclick="unbindPool(this)" style="margin-left: 10px">解绑</button>';
                        }

                        var tr = '<tr data-id="'+data[i].id+'" device-id="'+data[i].deviceId+'" pool-id="'+data[i].poolId+'">\n' +
                            '                        <td>'+data[i].deviceName+'</td>\n' +
                            '                        <td>'+data[i].imei+'</td>\n' +
                            '                        <td>'+data[i].params+'</td>\n' +
                            '                        <td>'+status+'</td>\n' +
                            '                        <td>'+poolName+'</td>\n' +
                            '                        <td>'+data[i].updateDate+'</td>\n' +
                            '                        <td>' + poolButton + '\n' +
                            '<button class="btn btn-info" onclick="showDevStatus(this)" style="margin-left: 10px">状态</button>\n' +
                            '<button class="btn btn-danger" onclick="deleteDevice(this)" style="margin-left: 10px">删除</button></td>\n' +
                            '                    </tr>';
                        html += tr + "\n";
                    }
                    document.getElementById('deviceTbody').innerHTML = html;
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }
</script>
</body>
</html>