<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>塘口管理-智慧水产养殖系统</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/toastr.css">
    <link rel="stylesheet" href="../css/breed.css">
</head>
<body>
<div class="container-fluid">
    <!-- 侧边栏 -->
    <div class="panel panel-default col-sm-2">
        <ul class="nav nav-pills nav-stacked">
            <li role="presentation"><a href="/">首页</a></li>
            <li role="presentation" class="active"><a href="/pool">塘口管理</a></li>
            <li role="presentation"><a href="/device">设备管理</a></li>
            <li role="presentation"><a href="/system">系统设置</a></li>
            <li role="presentation"><a href="/logout">退出</a></li>
        </ul>
    </div>
    <!-- 主体 -->
    <div class="panel panel-default col-sm-10">
        <h3 class="custom-panel-title">塘口列表</h3>
        <div class="panel-heading">
            <form class="form-inline">
                <div class="form-group">
                    <button class="btn btn-info" type="button" data-toggle="modal" data-target="#poolModel">添加塘口</button>
                </div>
                <div class="form-group">
                    <input type="text" id="poolName" class="form-control" placeholder="请输入塘口名称">
                </div>
                <button type="button" class="btn btn-default" onclick="findPool()">查找</button>
            </form>
        </div>
        <div class="panel-body">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>名称</th>
                    <th>面积（亩）</th>
                    <th>深度（米）</th>
                    <th>水产品种</th>
                    <th>投放密度（尾/亩）</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="poolTbody"></tbody>
            </table>
            <!-- 塘口设备模态框 -->
            <div class="modal fade" id="deviceModel" tabindex="-1" role="dialog" aria-labelledby="deviceModelLabel">
                <div class="modal-dialog" role="document" style="width:1100px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="deviceModelLabel">设备列表</h4>
                        </div>
                        <div class="modal-body" id="deviceModelBody">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 塘口模态框 -->
            <div class="modal fade" id="poolModel" tabindex="-1" role="dialog" aria-labelledby="poolModelLabel">
                <div class="modal-dialog" role="document" style="width:1100px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="poolModelLabel">添加/修改塘口</h4>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal" id="poolForm">
                                <input type="hidden" id="inputId" name="id">
                                <div class="form-group">
                                    <label for="inputName" class="col-sm-2 control-label">名称</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="inputName" name="name">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputAreas" class="col-sm-2 control-label">面积（亩）</label>
                                    <div class="col-sm-10">
                                        <input type="number" class="form-control" id="inputAreas" name="areas">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputDepth" class="col-sm-2 control-label">深度（米）</label>
                                    <div class="col-sm-10">
                                        <input type="number" class="form-control" id="inputDepth" name="depth">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputAquatic" class="col-sm-2 control-label">水产品种（多个用逗号分隔）</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="inputAquatic" name="aquatic">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputDensity" class="col-sm-2 control-label">投放密度（尾/亩）</label>
                                    <div class="col-sm-10">
                                        <input type="number" class="form-control" id="inputDensity" name="density">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" onclick="addPool()">添加</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../js/jquery-3.2.1.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/toastr.js"></script>
<script src="../js/http.js"></script>
<script src="../js/breed.js"></script>
<script>
    $(function () {
        sendJson("get", "/pool/", {}, false, function (res) {
                if (res.status) {
                    var data = res.data;
                    var html = "";
                    for(var i=0; i<data.length;i++) {
                        var tr = '<tr data-id="'+data[i].id+'">\n' +
                            '                        <td>'+data[i].name+'</td>\n' +
                            '                        <td>'+data[i].areas+'</td>\n' +
                            '                        <td>'+data[i].depth+'</td>\n' +
                            '                        <td>'+data[i].aquatic+'</td>\n' +
                            '                        <td>'+data[i].density+'</td>\n' +
                            '                        <td>'+data[i].createDate+'</td>\n' +
                            '                        <td>' +
                            '<button class="btn btn-primary" onclick="showDevice(this)">设备</button>' +
                            '<button class="btn btn-default" onclick="editPool(this)" style="margin-left: 10px">修改</button>' +
                            '<button class="btn btn-danger" onclick="deletePool(this)" style="margin-left: 10px">删除</button></td>\n' +
                            '                    </tr>';
                        html += tr + "\n";
                    }
                    document.getElementById('poolTbody').innerHTML = html;
                } else {
                    toastr.info(res.info);
                }
            },
            function () {
                toastr.error("系统错误");
            });
    });

    // 删除塘口
    function deletePool(obj) {
        var id = $(obj).parent().parent().attr("data-id");
        var msg = "删除后该塘口设备将被解绑，确定要删除吗";
        if(confirm(msg)) {
            sendJson("delete", "/pool/" + id, {}, false, function (res) {
                    if(res.status) {
                        toastr.success("解绑成功");
                        window.location.reload();
                    } else {
                        toastr.info(res.info);
                    }
                },
                function () {
                    toastr.error("系统错误");
                });
        } else {
            return false;
        }
    }
    
    // 修改塘口
    function editPool(obj) {
        var id = $(obj).parent().parent().attr("data-id");
        sendJson("get", "/pool/" + id, {}, false, function (res) {
                if(res.status) {
                    var pool = res.data;
                    $("#inputId").val(pool.id);
                    $("#inputName").val(pool.name);
                    $("#inputAreas").val(pool.areas);
                    $("#inputDepth").val(pool.depth);
                    $("#inputAquatic").val(pool.aquatic);
                    $("#inputDensity").val(pool.density);
                    $('#poolModel').modal('show');
                } else {
                    toastr.info(res.info);
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }

    // 添加/更新塘口
    function addPool() {
        var poolId = $("#inputId").val();
        var ajaxType = "";
        if(poolId === "") {
            ajaxType = "post";
        } else {
            ajaxType = "put";
        }

        sendJson(ajaxType, "/pool/", $("#poolForm").serialize(), false, function (res) {
                if(res.status) {
                    window.location.reload();
                } else {
                    toastr.info(res.info);
                }
            },
            function () {
                toastr.error("系统错误");
            });
        $('#poolModel').modal('hide');
    }

    // 查找塘口
    function findPool() {
         var name  = $("#poolName").val();
        sendJson("get", "/pool/name/" + name, {}, false, function (res) {
                if (res.status) {
                    var data = res.data;
                    var html = "";
                    for(var i=0; i<data.length;i++) {
                        var tr = '<tr data-id="'+data[i].id+'">\n' +
                            '                        <td>'+data[i].name+'</td>\n' +
                            '                        <td>'+data[i].areas+'</td>\n' +
                            '                        <td>'+data[i].depth+'</td>\n' +
                            '                        <td>'+data[i].aquatic+'</td>\n' +
                            '                        <td>'+data[i].density+'</td>\n' +
                            '                        <td>'+data[i].createDate+'</td>\n' +
                            '                        <td>' +
                            '<button class="btn btn-primary" onclick="showDevice(this)">设备</button>' +
                            '<button class="btn btn-default" onclick="editPool(this)" style="margin-left: 10px">修改</button>' +
                            '<button class="btn btn-danger" onclick="deletePool(this)" style="margin-left: 10px">删除</button></td>\n' +
                            '                    </tr>';
                        html += tr + "\n";
                    }
                    document.getElementById('poolTbody').innerHTML = html;
                } else {
                    toastr.info(res.info);
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }

    // 查看设备
    function showDevice(obj) {
        var id = $(obj).parent().parent().attr("data-id");
        sendJson("get", "/pool/"+id+"/device", {}, false, function (res) {
                if(res.status) {
                    // 得到设备Map，K为设备ID
                    var deviceMap = res.data.device;
                    // K:设备ID；V：设备名
                    var deviceNameMap = res.data.deviceName;
                    var html = "";
                    // 遍历设备Map
                    for (var deviceId in deviceMap){
                        // 1、获取设备名
                        var deviceName = deviceNameMap[deviceId];
                        // 2、获取这种设备的集合
                        var deviceList = deviceMap[deviceId];
                        // 3、拼接数据
                        html +='<h4>'+deviceName+'：</h4>\n';
                        var tds = "";
                        for(var i=0; i<deviceList.length; i++) {
                            var status = "";
                            if(deviceList[i].status === 1) {
                                status = "<span style='color: green'>START</span>";
                            } else {
                                status = "<span style='color: red'>STOP</span>";
                            }
                            tds += '<tr>\n' +
                                '                                    <td>'+deviceList[i].imei+'</td>\n' +
                                '                                    <td>'+status+'</td>\n' +
                                '                                    <td>'+deviceList[i].params+'</td>\n' +
                                '                                    <td>'+deviceList[i].updateDate+'</td>\n' +
                                '                                </tr>';
                        }
                        var tableHtml = '<table class="table table-hover">\n' +
                            '                                <thead>\n' +
                            '                                <tr>\n' +
                            '                                    <th>IMEI</th>\n' +
                            '                                    <th>状态</th>\n' +
                            '                                    <th>回传参数</th>\n' +
                            '                                    <th>同步时间</th>\n' +
                            '                                </tr>\n' +
                            '                                </thead>\n' +
                            '                                <tbody>\n' + tds + '\n' +
                            '                                </tbody>\n' +
                            '                            </table>';
                        html += tableHtml + '\n';
                    }
                    document.getElementById('deviceModelBody').innerHTML = html;
                    $('#deviceModel').modal('show');
                } else {
                    toastr.info(res.info);
                }
            },
            function () {
                toastr.error("系统错误");
            });
    }
</script>
</body>
</html>